# OpenCV Card Detector

<img src="./img/banner.jpg" alt="Banner OpenCV Card Detector">

> Um projeto com OpenCV em Java para detectar e reconhecer cartas de baralho em tempo real usando uma webcam.

## üìù Sobre o projeto

OpenCV Card Detector √© um projeto que usa a biblioteca OpenCV para detectar e reconhecer cartas de baralho em tempo real
usando uma webcam. Ele permite capturar e processar quadros de uma webcam, encontrar, extrair e predizer o valor e o
naipe de uma carta, al√©m de desenhar informa√ß√µes na imagem. O projeto tamb√©m implementa um jogo simples de cartas usando
essas funcionalidades.

Este projeto foi criado por Igor Oliveira como um trabalho pr√°tico para o curso de Eng. da Computa√ß√£o. O objetivo deste
projeto √© demonstrar o uso da biblioteca OpenCV para realizar opera√ß√µes de processamento de imagem em Java.

## üåü Inpira√ß√£o

Este projeto foi inspirado pelo
projeto [OpenCV-Playing-Card-Detector](https://github.com/EdjeElectronics/OpenCV-Playing-Card-Detector) de Edje
Electronics. Esse projeto usa a biblioteca OpenCV em Python para detectar e reconhecer cartas de baralho em tempo real
usando uma c√¢mera.

O meu projeto √© uma releitura desse projeto para Java, usando a biblioteca opencv-java. Eu tamb√©m fiz v√°rias
modifica√ß√µes e melhorias no c√≥digo, como alguns padr√µes de projeto, vari√°veis de ambiente para configurar alguns
par√¢metros e usar anota√ß√µes do lombok para reduzir a verbosidade do c√≥digo.

Al√©m disso, utilizei estrat√©gias diferentes, como verificar porcentagem de pixels pretos nas bordas para detectar uma
imagem na vertical ou na horizontal, e na detec√ß√£o de imagens usar o template matching para predizer os valores e naipes
das cartas. O template matching consiste em comparar a imagem do canto da carta com imagens de refer√™ncia dos valores e
naipes das cartas, e escolher o valor e o naipe com o maior grau de similaridade. Eu tamb√©m implementei um jogo simples
de cartas chamado ‚ÄúCan you twenty one?‚Äù, que consiste em somar 21 pontos com as cartas mostradas na webcam. Esse jogo
demonstra o uso das funcionalidades do OpenCV para criar uma aplica√ß√£o interativa e divertida.

Eu agrade√ßo ao [Edje Electronics](https://github.com/EdjeElectronics/) por compartilhar o seu projeto e me inspirar a
criar o meu. Eu recomendo que voc√™ visite o seu reposit√≥rio e veja o seu trabalho.

## ‚öôÔ∏è Funcionamento

Este projeto funciona da seguinte forma:

1. O projeto usa a classe ``CamService`` para capturar quadros de uma webcam usando a biblioteca ``OpenCV``. A
   classe ``CamService`` recebe um √≠ndice da webcam e uma fun√ß√£o de callback que processa os quadros capturados.

2. A fun√ß√£o de callback usa os m√©todos da classe ``OpenCVService`` para realizar opera√ß√µes de processamento de imagem
   nos quadros. A classe ``OpenCVService`` fornece v√°rios m√©todos para tratar imagens, encontrar contornos, extrair
   informa√ß√µes de cartas e desenhar em imagens.

3. O primeiro passo √© tratar a imagem usando o m√©todo ``treatImage``, que aplica um filtro de desfoque e uma detec√ß√£o de
   bordas Canny no quadro.

4. O segundo passo √© encontrar os contornos externos ordenados por √°rea usando o
   m√©todo``returnOrderedAndExternalContours``, que usa o m√©todo ``findContours`` da biblioteca OpenCV e aplica alguns
   filtros nos contornos encontrados.

5. O terceiro passo √© extrair os contornos das cartas usando o m√©todo ``getAllCardsContours``, que filtra os contornos
   baseado na sua √°rea e forma, e verifica se eles t√™m quatro v√©rtices.

6. O quarto passo √© processar as cartas usando o m√©todo ``getProcessedCard``, que recebe um contorno de carta e retorna
   um objeto da classe Card com as informa√ß√µes da carta.

    - O m√©todo ``getProcessedCard`` realiza as seguintes opera√ß√µes:

        1. Calcula as dimens√µes do contorno da carta usando o m√©todo ``getCardDimensions``, que obt√©m as coordenadas do
           centro, a largura e a altura do ret√¢ngulo que envolve o contorno.

        2. Corta e achata a imagem da carta usando o m√©todo ``cutAndFlatCard``, que usa a transforma√ß√£o de perspectiva
           para obter uma imagem plana da carta a partir do contorno.

        3. Extrai o canto da imagem da carta usando o m√©todo ``getCorner``, que obt√©m uma submatriz da imagem da carta
           correspondente ao canto superior esquerdo, e a redimensiona e binariza para obter as imagens do valor e do
           naipe do canto.

        4. Prediz o valor e o naipe da carta usando o m√©todo ``predictCard``, que usa o ``template matching`` para
           comparar as imagens do valor e do naipe do canto com as imagens de refer√™ncia das enumera√ß√µes ``Ranks``
           e ``Suits``, e escolhe o valor e o naipe com o maior grau de similaridade.

7. O quinto passo √© desenhar as informa√ß√µes na imagem usando os m√©todos ``drawText``, ``drawContours`` e ``drawCards``,
   que usam os m√©todos ``putText`` e ``drawContours`` da biblioteca OpenCV para desenhar texto, contornos e cartas na
   imagem.

8. O sexto passo √© retornar o quadro processado pela fun√ß√£o de ``callback``, que ser√° mostrado na janela da webcam pelo
   m√©todo ``imshow`` da biblioteca OpenCV.

## üíª Pr√©-requisitos

Para instalar este projeto, voc√™ precisa ter o ``Java 17`` instalado na sua m√°quina. Voc√™ tamb√©m precisa ter o ``Maven``
para
gerenciar as depend√™ncias do projeto. As depend√™ncias usadas neste projeto s√£o:

* ``lombok``: Uma biblioteca que fornece anota√ß√µes para reduzir a verbosidade do c√≥digo Java.

* ``opencv``: Uma biblioteca que fornece v√°rias opera√ß√µes de processamento de imagem.

* ``dotenv-java``: Uma biblioteca que permite carregar vari√°veis de ambiente de um arquivo .env.

* ``log4j-core``: Uma biblioteca que fornece funcionalidades de logging.

## üöÄ Instalando o OpenCV Card Detector

Para instalar este projeto, siga os seguintes passos:

1. Clone este reposit√≥rio na sua m√°quina local usando o comando git clone
   ``https://github.com/reedbluue/opencv-card-detector.git``.

2. Entre na pasta do projeto usando o comando ``cd opencv-card-detector``.

3. Crie um arquivo chamado ``.env ``na raiz do projeto e defina as seguintes vari√°veis de ambiente:
    - ``MIN_CARD_AREA``: √Årea m√≠nima de um contorno de carta
    - ``MAX_CARD_AREA``: √Årea m√°xima de um contorno de carta
    - ``MAX_BLACK_PER_CENT``: Porcentagem m√°xima de pixels pretos em um canto de carta

    > Voc√™ pode usar a classe ``CardAreaTest`` para consultar os valores m√≠nimos e m√°ximos da √°rea das cartas que voc√™ 
    > vai usar. Essa classe captura e processa quadros da c√¢mera e mostra a √°rea dos contornos encontrados na imagem. 
    > Isso √© √∫til para ajustar os par√¢metros do projeto de acordo com o tipo e tamanho das cartas que voc√™ vai usar.

3. Compile o projeto usando o comando ``mvn compile``.

4. Execute o projeto usando o comando ``mvn exec:java -Dexec.mainClass="dev.ioliver.ExampleGame"``.

## ‚òï Usando o OpenCV Card Detector

Para usar este projeto, voc√™ precisa ter uma webcam conectada ao seu computador. Voc√™ pode escolher o √≠ndice da webcam
que voc√™ quer usar no construtor da classe CamService. Por exemplo, se voc√™ quiser usar a primeira webcam dispon√≠vel,
voc√™ pode fazer:

``` java
CamService camService=new CamService(0,frame->{
  // Aqui voc√™ pode processar o quadro capturado pela webcam
});
```

O segundo par√¢metro do construtor da classe CamService √© uma fun√ß√£o de callback que recebe um quadro capturado pela
webcam e retorna um quadro processado. Voc√™ pode usar os m√©todos da classe OpenCVService para realizar opera√ß√µes de
processamento de imagem no quadro. Por exemplo, se voc√™ quiser tratar a imagem e encontrar os contornos externos
ordenados, voc√™ pode fazer:

``` java
CamService camService = new CamService(0, frame -> {
    List<MatOfPoint> contours = OPENCV_SERVICE.returnOrderedAndExternalContours(frame);
        // Aqui voc√™ pode fazer algo com os contornos encontrados
    return frame;
});
```

Se voc√™ quiser extrair os contornos das cartas do quadro, voc√™ pode usar o m√©todo getAllCardsContours. Por exemplo, se
voc√™ quiser desenhar os contornos das cartas na imagem, voc√™ pode fazer:

``` java
CamService camService = new CamService(0, frame -> {
    List<CardContour> cardsContours = OPENCV_SERVICE.getAllCardsContours(frame);
    OPENCV_SERVICE.drawContours(frame, cardsContours);
    return frame;
});
```

Se voc√™ quiser processar uma carta e extrair suas informa√ß√µes, como valor e naipe, voc√™ pode usar o m√©todo
getProcessedCard. Por exemplo, se voc√™ quiser desenhar o valor e o naipe de cada carta na imagem, voc√™ pode fazer:

``` java
CamService camService = new CamService(0, frame -> {
    List<CardContour> cardsContours = OPENCV_SERVICE.getAllCardsContours(frame);
    List<Card> processedCards = new ArrayList<>();
    cardsContours.forEach(contour -> {
        CardDimensions cardDimension = OPENCV_SERVICE.getCardDimensions(contour);
        Card processedCard = OPENCV_SERVICE.getProcessedCard(contour, cardDimension);
        processedCards.add(processedCard);
    });
    OPENCV_SERVICE.drawCards(frame, processedCards);
    return frame;
});
```

Voc√™ pode ver mais exemplos de utiliza√ß√£o das classes CamService e OpenCVService nas classes CardDetectorTest,
CardAreaTest e ExampleGame.

## üìÑ Documenta√ß√£o

Todo o projeto (ou pelo menos maior parte dele :x) foi documentado utilizando o JavaDoc. √â poss√≠vel ter acesso atrav√©s
do link: https://reedbluue.github.io/opencv-card-detector/

## üé• Demonstra√ß√µes

> ![Alt Text](./img/demo1.gif)
> Classe ``CardDetectorTest``. Utilizei um fundo verde para melhorar a detec√ß√£o dos contornos.

> ![Alt Text](./img/demo2.gif)
> Classe ``CardAreaTest``. Utilize essa classe para visualizar a √°rea ideal para seu tipo de carta.

> ![Alt Text](./img/demo3.gif)
> Classe ``ExampleGame``. Implementa√ß√£o da detec√ß√£o de cartas em um jogo simples :D

## ü§ù Reconhecimentos

* [Edje Electronics](https://github.com/EdjeElectronics/) - pela inspira√ß√£o com seu projeto
* [Jos√© Marcelo PIT](https://github.com/jmarcelopit) - por todo apoio e mentoria no projeto.

## üôãüèæ‚Äç‚ôÇÔ∏è Autor

* [Igor E. Oliveira](https://github.com/reedbluue) - Just another person

## üìù Licen√ßa

Esse projeto est√° sob licen√ßa. Veja o arquivo [LICEN√áA](../../../Desktop/opencv-card-detector/LICENSE) para mais
detalhes.